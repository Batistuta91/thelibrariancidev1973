

<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×”×¡×¤×¨× ×™×ª â€“ ××¢×¨×›×ª ×¡×¤×¨×™×™×” ×“×™×’×™×˜×œ×™×ª</title>
    <link href="https://fonts.googleapis.com/css?family=Heebo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body {
    font-family: 'Heebo', Arial, sans-serif;
    background: #f7f9fb;
    margin: 0;
    padding: 0;
    direction: rtl;
}
 header {
            background-image: url('https://github.com/Batistuta91/thelibrariancidev1973/blob/main/librarian.jpg?raw=true');
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
            height: 600px;
            width: 100%;
            position: relative;
        }


.main-title {
    position: absolute;
    left: 50%;
    bottom: 28px;
    transform: translateX(-50%);
    z-index: 2;
    color: #fff;
    background: rgba(37, 45, 63, 0.54);
    padding: 13px 34px 11px 34px;
    border-radius: 14px;
    font-size: 2em;
    font-weight: 700;
    letter-spacing: 2px;
    box-shadow: 0 3px 22px 0 rgba(0,0,0,0.12);
    border-bottom: 3px solid #43a047;
    text-align: center;
    width: max-content;
    max-width: 94vw;
    overflow-wrap: break-word;
}



/* ×™×•×¦×¨ ××–×•×¨ ×©××—×–×™×§ ××ª ×”×ª××•× ×” ×‘×¨×§×¢ ×’× ×›×©×”header ×¨×™×§ */
header::after {
    content: "";
    display: block;
    position: absolute;
    inset: 0;
    z-index: 0;
    background: inherit;
    pointer-events: none;
}

header::before {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(120deg, rgba(28,35,51,0.13) 40%, rgba(68,91,130,0.04) 100%);
    /* ×©×™× ×œ×‘: ×©×™× ×™×ª×™ ××ª ×”×¢×¨×›×™× ×œÖ¾0.13 ×•Ö¾0.04 ×‘×œ×‘×“ */
    z-index: 1;
    border-bottom-left-radius: 14px;
    border-bottom-right-radius: 14px;
    pointer-events: none;
}

main {
    margin: 0 auto;
    max-width: 920px;
    padding: 28px 10px 44px 10px;
}
.tabs-bar {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-bottom: 18px;
    flex-wrap: wrap;
}
.tab-btn {
    background: #4caf50;
    color: #fff;
    border: none;
    border-radius: 10px 10px 0 0;
    padding: 13px 28px;
    font-size: 1.11em;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.12s, color 0.13s;
    box-shadow: 0 2px 12px #e0e0e03a;
    margin-bottom: -2px;
}
.tab-btn.active, .tab-btn:focus {
    background: #1976d2;
    color: #fff;
}
.tab-btn:hover {
    background: #399440;
}
.tab-content {
    display: none;
    background: #fafafa;
    border: 1.5px solid #e0e0e0;
    border-radius: 0 0 10px 10px;
    padding: 26px 26px 18px 26px;
    margin-bottom: 16px;
    box-shadow: 0 4px 14px #e0e0e033;
    animation: openTab 0.27s;
}
.tab-content.open {
    display: block;
}
@keyframes openTab {
    0% { opacity: 0; transform: translateY(-12px);}
    100% { opacity: 1; transform: translateY(0);}
}
input, textarea, select {
    font-size: 1.06em;
    border-radius: 7px;
    border: 1.2px solid #c7d0e2;
    padding: 10px;
    margin-bottom: 13px;
    width: 100%;
    box-sizing: border-box;
    font-family: inherit;
    background: #f6f9fc;
    transition: border 0.15s;
    outline: none;
}
input:focus, textarea:focus, select:focus {
    border-color: #1976d2;
    background: #f0f7fa;
}
.button {
    background: linear-gradient(90deg, #1976d2 70%, #43a047 100%);
    color: #fff;
    border: none;
    border-radius: 7px;
    padding: 9px 28px;
    font-size: 1.09em;
    cursor: pointer;
    margin: 0 0 0 7px;
    transition: background 0.14s, transform 0.12s;
    font-weight: 600;
    box-shadow: 0 1px 6px #c1c4ce33;
}
.button:hover, .button:focus {
    background: linear-gradient(90deg, #184d94 55%, #258d3b 100%);
    transform: translateY(-2px) scale(1.03);
}
.success, .error {
    margin-top: 16px;
    padding: 12px 18px;
    border-radius: 7px;
    font-weight: 700;
    text-align: center;
    max-width: 350px;
    margin-left: auto;
    margin-right: auto;
    font-size: 1.11em;
    letter-spacing: 0.5px;
    box-shadow: 0 1px 6px #c1d9b12e;
    opacity: 0.97;
}
.success { background: #e5f8e4; color: #26732c;}
.error { background: #fae7e7; color: #a30d0d;}
.hidden { display: none !important; }
.main-section {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 14px 0 rgba(44,44,44,0.09);
    padding: 22px 28px 18px 28px;
    margin-bottom: 18px;
}
h2 {
    color: #43a047;
    font-size: 1.35em;
    margin-bottom: 16px;
    font-weight: 700;
}
.book-list {
    margin-top: 22px;
}
.book-item {
    display: flex;
    align-items: flex-start;
    border-bottom: 1px solid #eee;
    padding: 13px 0 11px 0;
    background: #fdfdfd;
    border-radius: 7px;
    margin-bottom: 10px;
    transition: box-shadow 0.16s;
    gap: 0 18px;
}
.book-item:hover {
    box-shadow: 0 2px 18px 0 #dbe4f433;
}
.book-item:last-child {
    border-bottom: none;
    margin-bottom: 0;
}
.book-img {
    width: 120px;
    height: 170px;
    object-fit: cover;
    border-radius: 7px;
    margin-left: 0;
    margin-right: 12px;
    border: 1px solid #e2e5ea;
    box-shadow: 0 1px 5px #c7d0e2a6;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    flex-shrink: 0;
    background: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #999;
    font-size: 12px;
}
.book-img:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(25, 118, 210, 0.3);
}
.book-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    min-width: 0;
}
.book-title-author {
    font-size: 1.1em;
    color: #1c2333;
    display: flex;
    flex-direction: column;
    gap: 3px;
    margin-bottom: 2px;
}
.book-title {
    font-weight: bold;
    font-size: 1.25em;
    color: #1976d2;
    margin-bottom: 1px;
    line-height: 1.15;
    word-break: break-word;
}
.book-author {
    color: #777;
    font-size: 1em;
    margin-bottom: 3px;
    line-height: 1.1;
}
.book-summary {
    color: #333;
    margin: 4px 0 6px 0;
    font-size: 1.07em;
    word-break: break-word;
    line-height: 1.4;
}
.book-actions {
    margin-top: 4px;
    display: flex;
    gap: 7px;
    flex-wrap: wrap;
}
.add-image-btn {
    background: linear-gradient(90deg, #1976d2 70%, #43a047 100%);
    color: #fff;
    border: none;
    border-radius: 7px;
    padding: 7px 18px;
    font-size: 1em;
    cursor: pointer;
    font-weight: 600;
    box-shadow: 0 1px 6px #c1c4ce33;
}
.add-image-btn:hover, .add-image-btn:focus {
    background: linear-gradient(90deg, #184d94 55%, #258d3b 100%);
    transform: translateY(-2px) scale(1.03);
}
.delete-comment-btn {
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    padding: 2px 6px;
    font-size: 0.8em;
    cursor: pointer;
    margin-right: 5px;
    transition: background 0.2s;
}
.delete-comment-btn:hover {
    background: #c82333;
}
.button-gray {
    background: #757575;
}
.button-small {
    padding: 2px 9px;
    font-size: 0.85em;
    background: #d32f2f;
}
.image-modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.9);
    animation: fadeIn 0.3s;
}
.modal-content {
    position: relative;
    margin: auto;
    display: block;
    width: 80%;
    max-width: 700px;
    top: 50%;
    transform: translateY(-50%);
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
}
.close-modal {
    position: absolute;
    top: 15px;
    right: 35px;
    color: #f1f1f1;
    font-size: 40px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
    z-index: 10000;
}
.close-modal:hover {
    color: #bbb;
}
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* ×¨×¡×¤×•× ×¡×™×‘×™×•×ª */
@media (max-width: 900px) {
    main { max-width: 100vw; }
    .main-section { padding: 10px 2vw 10px 2vw; }
    .tab-content { padding: 10px 1vw 10px 1vw; }
    .book-img { width: 80px; height: 112px; margin-right: 6px;}
    .book-item { gap: 0 8px; }
}

/* ×ª×™×§×•×Ÿ ××¨×›×– ×•×ª××•× ×” ×œ×›×¨×˜×™×¡×™× + header ×§×˜×Ÿ ×‘××•×‘×™×™×œ + ×›×•×ª×¨×•×ª ×××•×¨×›×–×•×ª */
@media (max-width: 900px) {
    main { max-width: 100vw; }
    .main-section { padding: 10px 2vw 10px 2vw; }
    .tab-content { padding: 10px 1vw 10px 1vw; }
    .book-img { width: 80px; height: 112px; margin-right: 6px;}
    .book-item { gap: 0 8px; }
}

/* ××•×‘×™×™×œ â€“ ×”×’×“×œ×” × ×•×¡×¤×ª ×œ×ª××•× ×” */
@media (max-width: 600px) {
    header {
        height: 170px !important;
    }
    .main-title {
        font-size: 1.05em !important;
        padding: 7px 12px 7px 12px !important;
    }
    .main-section { padding: 8px 1vw 8px 1vw;}
    .tabs-bar { gap: 5px;}
    .tab-btn { width: 100% !important; min-width: 0; font-size: 1em; }
    .tab-content { padding: 7px 1.2vw; }
    .book-item {
        flex-direction: column;
        align-items: center;
        gap: 6px 0;
    }
    .book-img {
        width: 90px;
        height: 126px;
        margin: 0 auto 10px auto !important;
        display: block !important;
    }
    .book-info {
        align-items: center !important;
        text-align: center !important;
        width: 100%;
        margin-right: 0 !important;
    }
    .book-title-author,
    .book-title,
    .book-author {
        text-align: center !important;
        width: 100%;
        margin: 0 auto !important;
    }
    .book-actions {
        flex-direction: column;
        gap: 4px;
        align-items: center;
    }
    h2 {
        text-align: center !important;
        width: 100%;
        margin-left: auto;
        margin-right: auto;
    }
}

@media (max-width: 480px) {
    header {
        height: 110px !important;
    }
    .main-title {
        font-size: 0.93em !important;
        padding: 5px 7px 5px 7px !important;
    }
    .tab-content, .main-section { padding: 3vw 0.5vw; }
    .book-img {
        width: 80px;
        height: 112px;
    }
    .tab-btn { font-size: 0.92em; }
}


.accessibility-menu {
    position: fixed;
    left: 22px;
    bottom: 28px;
    z-index: 5000;
    background: #f7f7f7;
    border-radius: 14px;
    box-shadow: 0 3px 16px 0 rgba(0,0,0,0.18);
    padding: 12px 14px 7px 14px;
    display: none;
    min-width: 164px;
    direction: rtl;
}
.accessibility-menu.open {
    display: block;
    animation: fadeIn .28s;
}
.accessibility-menu button {
    background: #1976d2;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 7px 15px;
    margin: 0 0 7px 0;
    font-size: 1em;
    cursor: pointer;
    transition: background 0.14s;
    width: 100%;
    text-align: right;
    font-family: inherit;
}
.accessibility-menu button:last-child { margin-bottom: 0; }
.accessibility-btn {
    position: fixed;
    left: 22px;
    bottom: 22px;
    width: 56px;
    height: 56px;
    background: #1976d2 !important;
    color: #fff !important;
    border-radius: 50%;
    border: 3px solid #ffd600 !important;
    box-shadow: 0 2px 12px 0 rgba(0,0,0,0.20);
    font-size: 27px;
    z-index: 99999 !important;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.13s, color 0.13s, border 0.13s;
    opacity: 1 !important;
}
.accessibility-btn:active { background: #145fa5 !important; }
body.accessibility-contrast .accessibility-btn {
    background: #000 !important;
    color: #fff !important;
    border: 3px solid #ffd600 !important;
    box-shadow: 0 0 8px 2px #ffd600b8 !important;
}
body.accessibility-dark .accessibility-btn {
    background: #fff !important;
    color: #1976d2 !important;
    border: 3px solid #1976d2 !important;
    box-shadow: 0 0 8px 2px #1976d2a2 !important;
}

/* ××¦×‘ ×›×”×” - ×©××™×¨×ª ×ª××•× ×” ×ª××™×“! */
body.accessibility-dark header,
body.accessibility-dark header::before {
    background-image: url(https://cdn.glitch.global/9d6cc108-a698-4ad6-9591-d17c03047774/librarian.jpg?v=1721631637207) !important;
    background-size: cover !important;
    background-position: center !important;
}
body.accessibility-dark header::before {
    background: linear-gradient(120deg, rgba(0,0,0,0.8) 40%, rgba(26,34,44,0.6) 100%) !important;
}
body.accessibility-dark,
body.accessibility-dark main,
body.accessibility-dark .main-section,
body.accessibility-dark .tab-content,
body.accessibility-dark .book-item,
body.accessibility-dark .book-img,
body.accessibility-dark .book-title,
body.accessibility-dark .book-author,
body.accessibility-dark .book-summary {
    background: #1a222c !important;
    color: #fff !important;
    border-color: #333 !important;
}
body.accessibility-dark .button,
body.accessibility-dark .add-image-btn {
    background: #1976d2 !important;
    color: #fff !important;
    border: 2px solid #fff !important;
}
body.accessibility-dark .tab-btn {
    background: #24314b !important;
    color: #fff !important;
}
body.accessibility-dark input,
body.accessibility-dark textarea,
body.accessibility-dark select {
    background: #2a3a4a !important;
    color: #fff !important;
    border-color: #444 !important;
}
body.accessibility-dark input:focus,
body.accessibility-dark textarea:focus,
body.accessibility-dark select:focus {
    background: #334455 !important;
    border-color: #1976d2 !important;
}
/* × ×™×’×•×“×™×•×ª ×’×‘×•×”×” */
body.accessibility-contrast header,
body.accessibility-contrast header::before {
    background-image: url(https://cdn.glitch.global/9d6cc108-a698-4ad6-9591-d17c03047774/librarian.jpg?v=1721631637207) !important;
    background-size: cover !important;
    background-position: center !important;
}
body.accessibility-contrast header::before {
    background: linear-gradient(120deg, rgba(255,255,255,0.65) 35%, rgba(255,255,255,0.01) 100%) !important;
}
body.accessibility-contrast,
body.accessibility-contrast main,
body.accessibility-contrast .main-section,
body.accessibility-contrast .tab-content,
body.accessibility-contrast .book-item,
body.accessibility-contrast header,
body.accessibility-contrast .book-img,
body.accessibility-contrast .book-title,
body.accessibility-contrast .book-author,
body.accessibility-contrast .book-summary {
    background: #fff !important;
    color: #000 !important;
    border-color: #222 !important;
}
body.accessibility-contrast .button,
body.accessibility-contrast .add-image-btn {
    background: #000 !important;
    color: #ffd600 !important;
    border: 2px solid #ffd600 !important;
}
body.accessibility-contrast .tab-btn {
    background: #000 !important;
    color: #ffd600 !important;
}
 @media (max-width: 768px) {
            .book-info {
                flex-direction: column;
                align-items: flex-start;
            }
            .book-actions {
                margin-top: 10px;
                width: 100%;
                justify-content: flex-start;
            }
            .borrow-form input {
                width: calc(100% - 10px);
                margin-top: 10px;
                margin-right: 0;
            }
            .button {
                font-size: 18px;
                padding: 8px;
            }
            .mobile-view .button {
                font-size: 16px;
                padding: 6px;
            }
            .mobile-view .book-actions button {
                width: auto;
                margin-right: 5px;
            }
            .mobile-view .borrow-form {
                flex-direction: column;
                align-items: flex-start;
            }
            .mobile-view .borrow-form input {
                width: 100%;
                margin-bottom: 5px;
            }
            .mobile-view .book-info,
            .mobile-view .book-actions {
                flex-direction: column;
                align-items: flex-start;
            }
            .mobile-view .book-actions {
                margin-top: 10px;
            }
        }
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            .book-list, .borrowed-books, .add-book, .import-books, .export-books, .edit-summary, .search-books, .clear-data {
                padding: 15px;
                margin-bottom: 15px;
            }
            .borrow-form input {
                width: 100%;
            }
        }
        .message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .mobile-view-toggle {
            display: none;
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }
        .mobile-view-toggle button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        .mobile-view {
            max-width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }
        .mobile-view .book-item {
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 20px;
        }
        .mobile-view .book-info,
        .mobile-view .book-actions {
            display: block;
            width: 100%;
        }
        .mobile-view .book-actions button {
            width: 100%;
            margin-bottom: 5px;
        }
        .mobile-view input[type="text"],
        .mobile-view textarea {
            width: 100%;
            box-sizing: border-box;
        }
  @media (max-width: 768px) {
    .book-info {
        display: flex;
        flex-direction: column;
        align-items: center; /* ×××¨×›×– ××ª ×›×œ ×”×ª×•×›×Ÿ */
        text-align: center; /* ××‘×˜×™×— ×©×”×›×•×ª×¨×ª ×ª×”×™×” ×××•×¨×›×–×ª */
    }
    

    .book-info img {
        width: auto;
        max-width: 200px;
        height: auto;
        margin: 0 auto; /* ×××¨×›×– ××ª ×”×ª××•× ×” */
        display: block; /* ××‘×˜×™×— ×©×”×ª××•× ×” ×ª×•×¦×’ ×›×‘×œ×•×§ ×××•×¨×›×– */
        order: -1; /* ××¢×‘×™×¨ ××ª ×”×ª××•× ×” ×œ××¢×œ×” */
    }

    .book-info span {
        margin-top: 10px;
        text-align: center; /* ×××¨×›×– ××ª ×›×•×ª×¨×ª ×”×¡×¤×¨ */
    }


</style>

</head>
<body>
<header>
</header>
<main>
    <div class="tabs-bar">
        <button class="tab-btn" onclick="openTab('addBookTab', this)">×”×•×¡×£ ×¡×¤×¨ ×—×“×© ï¼‹</button>
        <button class="tab-btn" onclick="openTab('importTab', this)">×™×‘× ×¡×¤×¨×™× ×××§×¡×œ â¬‡ï¸</button>
        <button class="tab-btn" onclick="openTab('exportTab', this)">×™×™×¦× ×¡×¤×¨×™× ×œ××§×¡×œ â¬†ï¸</button>
    </div>
    <div id="addBookTab" class="tab-content">
        <h2>×”×•×¡×¤×ª ×¡×¤×¨ ×—×“×©</h2>
        <input type="text" id="bookTitle" placeholder="×›×•×ª×¨×ª ×”×¡×¤×¨">
        <input type="text" id="bookAuthor" placeholder="×©× ×”××—×‘×¨">
        <textarea id="bookSummary" placeholder="×ª×§×¦×™×¨ ×”×¡×¤×¨"></textarea>
        <input type="text" id="bookImageUrl" placeholder="×§×™×©×•×¨ ×œ×ª××•× ×” (×œ× ×—×•×‘×”)">
        <input type="text" id="bookLocation" placeholder="××™×§×•× ×”×¡×¤×¨ (××“×£, ××–×•×¨, ×§×•×“)">
        <button class="button" onclick="addBook()">×”×•×¡×£ ×¡×¤×¨</button>
    </div>
    <div id="importTab" class="tab-content">
        <h2>×™×‘× ×¡×¤×¨×™× ×××§×¡×œ</h2>
        <input type="file" id="importExcel" accept=".xlsx,.xls">
        <input type="password" id="importCode" placeholder="×§×•×“" style="margin-top:5px;">
        <button class="button" onclick="importBooks()">×™×‘×</button>
    </div>
    <div id="exportTab" class="tab-content">
        <h2>×™×™×¦× ×¡×¤×¨×™× ×œ××§×¡×œ</h2>
        <input type="password" id="exportCode" placeholder="×§×•×“">
        <button class="button" onclick="exportBooks()">×™×™×¦×</button>
    </div>
    <!-- ×ª××™×“ ×¤×ª×•×— â€“ ×—×™×¤×•×© ×¡×¤×¨×™× -->
    <div class="main-section" id="searchSection">
        <h2>×—×™×¤×•×© ×¡×¤×¨×™× ğŸ”</h2>
        <div style="display:flex;gap:8px;">
            <input type="text" id="searchInput" placeholder="×—×¤×© ×¡×¤×¨×™× ...">
            <button class="button" id="searchBtn">×—×¤×©</button>
        </div>
        <div class="book-list" id="searchResults"></div>
    </div>
    <!-- ×ª××™×“ ×¤×ª×•×— â€“ ×¨×©×™××ª ×¡×¤×¨×™× -->
    <div class="main-section" id="bookListSection">
        <h2>×¨×©×™××ª ×¡×¤×¨×™× ğŸ“š</h2>
        <div id="booksContainer"></div>
    </div>
    <!-- ×ª××™×“ ×¤×ª×•×— â€“ ×¨×©×™××ª ××•×©××œ×™× -->
    <div class="main-section" id="borrowedBooksSection">
        <h2>×¡×¤×¨×™× ××•×©××œ×™× ğŸ”„</h2>
        <div id="borrowedContainer"></div>
    </div>
    <div id="messageBox"></div>
    <div id="imageModal" class="image-modal">
        <span class="close-modal" onclick="closeImageModal()">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>
    <!-- ×›×¤×ª×•×¨ ×¤×ª×™×—×ª ×ª×¤×¨×™×˜ × ×’×™×©×•×ª -->
    <button class="accessibility-btn" title="×ª×¤×¨×™×˜ × ×’×™×©×•×ª" onclick="toggleAccessibilityMenu()">
        <span aria-hidden="true">âš™ï¸</span>
    </button>

    <!-- ×ª×¤×¨×™×˜ ×”× ×’×™×©×•×ª ×¢×¦××• -->
    <div class="accessibility-menu" id="accessibilityMenu">
        <button onclick="setFontSize(+1)">×”×’×“×œ ×¤×•× ×˜</button>
        <button onclick="setFontSize(-1)">×”×§×˜×Ÿ ×¤×•× ×˜</button>
        <button onclick="resetFontSize()">×’×•×“×œ ×¨×’×™×œ</button>
        <button onclick="toggleContrast()">× ×™×’×•×“×™×•×ª ×’×‘×•×”×”</button>
        <button onclick="toggleDarkModeAcc()">××¦×‘ ×œ×™×œ×”/×›×”×”</button>
    </div>
</main>
<script>
/* --------- CONFIG --------- */
const BOOKS_API = "https://api.myjson.online/v1/records/a2a767ca-92e1-49fc-8e8a-23b04b541284";
const BOOK_IMAGES_API = "https://api.myjson.online/v1/records/1f5626cb-34b4-4b8f-948a-57d2695f3171";
const API_TOKEN = "a5a589e6-be1e-483e-8110-edd57cf4745f";
const CODE = "0548330010"; // ×§×•×“ ××‘×˜×—×”

/* --------- STATE --------- */
let books = [];
let borrowed = [];
let bookImages = {};
let comments = {}; // id: [ {user, text} ]

/* --------- UTIL --------- */
function showMessage(msg, isSuccess = true) {
    const box = document.getElementById('messageBox');
    box.textContent = msg;
    box.className = isSuccess ? 'success' : 'error';
    box.classList.remove('hidden');
    setTimeout(() => box.classList.add('hidden'), 2500);
}
function clearBookInputs() {
    document.getElementById('bookTitle').value = '';
    document.getElementById('bookAuthor').value = '';
    document.getElementById('bookSummary').value = '';
    document.getElementById('bookImageUrl').value = '';
    document.getElementById('bookLocation').value = '';
}
/* --------- ×¤×•× ×§×¦×™×•×ª ×œ×”×•×¡×¤×ª ×ª××•× ×” ×‘×¨××ª ×”×¡×¤×¨ --------- */
function startAddImage(id) {
    document.getElementById('addImageBox'+id).innerHTML = `
        <input type="text" id="imageUrl${id}" placeholder="×§×™×©×•×¨ ×œ×ª××•× ×”..." style="width:200px;display:inline-block;">
        <button class="button" style="padding:5px 12px;" onclick="addImageToBook(${id})">×”×•×¡×£</button>
        <button class="button" style="padding:5px 12px;background:#999;" onclick="cancelAddImage(${id})">×‘×™×˜×•×œ</button>
    `;
}

async function addImageToBook(id) {
    const imageUrl = document.getElementById('imageUrl'+id).value.trim();
    if (!imageUrl) return showMessage("× × ×œ×”×•×¡×™×£ ×§×™×©×•×¨ ×œ×ª××•× ×”", false);
    bookImages[id] = imageUrl;
    const book = books.find(b => b.id == id);
    if (book) { book.imageUrl = imageUrl; }
    const borrowedBook = borrowed.find(b => b.id == id);
    if (borrowedBook) { borrowedBook.imageUrl = imageUrl; }
    await saveBooks();
    await fetchBooks();
    showMessage("×ª××•× ×” × ×•×¡×¤×” ×‘×”×¦×œ×—×”!");
}

function cancelAddImage(id) {
    document.getElementById('addImageBox'+id).innerHTML = `
        <button class="add-image-btn" onclick="startAddImage(${id})">×”×•×¡×£ ×ª××•× ×”</button>
    `;
    const searchInput = document.getElementById('searchInput');
    if (searchInput.value.trim()) { searchBooks(); } else { renderBooks(); }
}

/* --------- ×¤×•× ×§×¦×™×•×ª ×œ×”×¦×’×ª ×ª××•× ×” ×‘××•×“×œ --------- */
function openImageModal(imageUrl) {
    const modal = document.getElementById('imageModal');
    const modalImg = document.getElementById('modalImage');
    modal.style.display = "block";
    modalImg.src = imageUrl;
}
function closeImageModal() { document.getElementById('imageModal').style.display = "none"; }
window.onclick = function(event) {
    const modal = document.getElementById('imageModal');
    if (event.target == modal) { modal.style.display = "none"; }
}

/* --------- FETCH BOOKS --------- */
async function fetchBooks() {
    try {
        const res = await fetch(BOOKS_API, {
            headers: { 'Content-Type': 'application/json', 'x-collection-access-token': API_TOKEN }
        });
        const json = await res.json();
        let data;
        if (json.jsonData) { try { data = JSON.parse(json.jsonData); } catch(e) { data = json.jsonData; } }
        else { data = json.data || {}; }
        if (Array.isArray(data)) {
            books = data;
            borrowed = [];
            comments = {};
        } else {
            books = data.books || [];
            borrowed = data.borrowed || [];
            comments = data.comments || {};
        }
        let imagesRes = await fetch(BOOK_IMAGES_API, {
            headers: { 'Content-Type': 'application/json', 'x-collection-access-token': API_TOKEN }
        });
        let imagesJson = await imagesRes.json();
        let imagesData;
        if (imagesJson.jsonData) { try { imagesData = JSON.parse(imagesJson.jsonData); } catch(e) { imagesData = imagesJson.jsonData; } }
        else { imagesData = imagesJson.data || {}; }
        if (Array.isArray(imagesData)) {
            bookImages = {};
            imagesData.forEach(item => { if (item.id && item.url) bookImages[item.id] = item.url; });
        } else { bookImages = imagesData || {}; }
        books.forEach(book => { const bookIdStr = String(book.id); if (bookImages[bookIdStr]) { book.imageUrl = bookImages[bookIdStr]; } });
        borrowed.forEach(book => { const bookIdStr = String(book.id); if (bookImages[bookIdStr]) { book.imageUrl = bookImages[bookIdStr]; } });
        renderBooks();
        renderBorrowed();
        searchBooks();
    } catch (e) {
        books = [];
        borrowed = [];
        comments = {};
        bookImages = {};
        renderBooks();
        renderBorrowed();
    }
}

async function saveBooks() {
    const data = { books, borrowed, comments };
    try {
        await fetch(BOOKS_API, {
            method: "PUT",
            headers: { 'Content-Type': 'application/json', 'x-collection-access-token': API_TOKEN },
            body: JSON.stringify({ jsonData: JSON.stringify(data) })
        });
        await fetch(BOOK_IMAGES_API, {
            method: "PUT",
            headers: { 'Content-Type': 'application/json', 'x-collection-access-token': API_TOKEN },
            body: JSON.stringify({ jsonData: JSON.stringify(bookImages) })
        });
    } catch (e) {}
}

/* --------- ACTIONS --------- */
// × ×™×”×•×œ ×¤×ª×™×—×ª ×œ×©×•× ×™×•×ª ×‘×˜××‘×™×
function openTab(tabId, btn) {
    // ×‘×“×•×§ ×× ×›×‘×¨ ×¤×ª×•×—
    const tab = document.getElementById(tabId);
    const isOpen = tab.classList.contains('open');
    // ×¡×’×•×¨ ×”×›×œ
    document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('open'));
    document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
    // ×× ×›×‘×¨ ×¤×ª×•×—, ××œ ×ª×¤×ª×— ×©×•×‘ (×•×›×›×” ×‘×¢×¦× ×ª×¡×’×•×¨)
    if (!isOpen) {
        tab.classList.add('open');
        btn.classList.add('active');
    }
}

async function addBook() {
    const title = document.getElementById('bookTitle').value.trim();
    const author = document.getElementById('bookAuthor').value.trim();
    const summary = document.getElementById('bookSummary').value.trim();
    const imageUrl = document.getElementById('bookImageUrl').value.trim();
    const location = document.getElementById('bookLocation').value.trim();

    const code = prompt("× × ×œ×”×–×™×Ÿ ×§×•×“ ×œ×¦×•×¨×š ×”×•×¡×¤×ª ×¡×¤×¨:");
    if (code !== CODE) { showMessage("×§×•×“ ×œ× × ×›×•×Ÿ. ×”×¡×¤×¨ ×œ× × ×•×¡×£.", false); return; }
    if (!title) return showMessage("× × ×œ××œ× ×›×•×ª×¨×ª", false);

    const id = Date.now();
    const newBook = { id, title, author, summary, location };
    if (imageUrl) {
        newBook.imageUrl = imageUrl;
        bookImages[id] = imageUrl;
    }
    books.push(newBook);
    await saveBooks();
    await fetchBooks();
    clearBookInputs();
    showMessage("×”×¡×¤×¨ × ×•×¡×£ ×‘×”×¦×œ×—×”!");
}

/* --------- ×¢×¨×™×›×ª ××™×§×•× --------- */
function startEditLocation(id) {
    const book = books.find(b => b.id == id);
    const location = (book && book.location) || '';
    document.getElementById('locationBox'+id).innerHTML = `
        <input type="text" id="locationInput${id}" style="width:180px;display:inline-block;" placeholder="××™×§×•× ×”×¡×¤×¨" value="${location}">
        <button class="button" style="padding:5px 12px;" onclick="saveLocation(${id})">×©××•×¨</button>
        <button class="button" style="padding:5px 12px;background:#999;" onclick="cancelEditLocation(${id})">×‘×™×˜×•×œ</button>
    `;
}
async function saveLocation(id) {
    const location = document.getElementById('locationInput'+id).value.trim();
    const book = books.find(b => b.id == id);
    if (book) {
        book.location = location;
        await saveBooks();
        await fetchBooks();
        showMessage("×”××™×§×•× ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!");
    }
}
function cancelEditLocation(id) { renderBooks(); }

/* --------- BORROW --------- */
function startBorrow(id) {
    document.getElementById('borrowBox'+id).innerHTML = `
        <input type="text" id="borrowUser${id}" placeholder="×©× ×©×•××œ" style="width:120px;display:inline-block;">
        <button class="button" style="padding:5px 16px;" onclick="borrowBook(${id})">×”×©××œ</button>
        <button class="button" style="padding:5px 12px;background:#999;" onclick="renderBooks()">×‘×™×˜×•×œ</button>
    `;
}
async function borrowBook(id) {
    const name = document.getElementById('borrowUser'+id).value.trim();
    if (!name) return showMessage("× × ×œ××œ× ×©×", false);
    const idx = books.findIndex(b=>b.id==id);
    if(idx>-1) {
        let b = books[idx];
        borrowed.push({...b, borrower: name, date: new Date().toLocaleDateString()});
        books.splice(idx,1);
        await saveBooks();
        await fetchBooks();
        showMessage("×”×¡×¤×¨ ×”×•×©××œ");
    }
}
async function returnBook(id) {
    const idx = borrowed.findIndex(b=>b.id==id);
    if(idx>-1) {
        let b = borrowed[idx];
        books.push({id:b.id, title:b.title, author:b.author, summary:b.summary, location:b.location});
        borrowed.splice(idx,1);
        await saveBooks();
        await fetchBooks();
        showMessage("×”×¡×¤×¨ ×—×–×¨");
    }
}

/* --------- ×ª×’×•×‘×” ×‘×¨××ª ×¡×¤×¨ --------- */
async function deleteComment(bookId, commentIndex) {
    if (!comments[bookId] || !comments[bookId][commentIndex]) return;
    if (confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×ª×’×•×‘×”?")) {
        comments[bookId].splice(commentIndex, 1);
        if (comments[bookId].length === 0) { delete comments[bookId]; }
        await saveBooks();
        await fetchBooks();
        showMessage("×”×ª×’×•×‘×” × ××—×§×” ×‘×”×¦×œ×—×”!");
    }
}
function startComment(id) {
    document.getElementById('commentBox'+id).innerHTML = `
        <input type="text" id="commentUser${id}" placeholder="×©× ××’×™×‘" style="width:120px;display:inline-block;">
        <input type="text" id="commentText${id}" placeholder="×ª×’×•×‘×”..." style="width:180px;display:inline-block;">
        <button class="button" style="padding:5px 12px;" onclick="addBookComment(${id})">×”×•×¡×£</button>
        <button class="button" style="padding:5px 12px;background:#999;" onclick="renderBooks()">×‘×™×˜×•×œ</button>
    `;
}
async function addBookComment(id) {
    const user = document.getElementById('commentUser'+id).value.trim();
    const text = document.getElementById('commentText'+id).value.trim();
    if (!user || !text) return showMessage("× × ×œ××œ× ×”×›×œ", false);
    if(!comments[id]) comments[id]=[];
    comments[id].push({user,text, date: new Date().toLocaleDateString()});
    await saveBooks();
    await fetchBooks();
    showMessage("×ª×’×•×‘×” × ×•×¡×¤×”");
}

/* --------- RENDER --------- */
const imageCache = new Map();
function preloadImage(src) {
    if (!imageCache.has(src)) {
        const img = new Image();
        img.src = src;
        imageCache.set(src, img);
    }
}

function renderBooks() {
    const container = document.getElementById('booksContainer');
    if (!books.length) { container.innerHTML = "<p style='color:#899;'>××™×Ÿ ×¡×¤×¨×™× ×‘×××’×¨</p>"; return; }
    books.forEach(book => { if (book.imageUrl || bookImages[book.id]) { preloadImage(book.imageUrl || bookImages[book.id]); } });
    container.innerHTML = books.map(book => `
      <div class="book-item">
          ${book.imageUrl || bookImages[book.id] ? 
            `<img class="book-img" src="${book.imageUrl || bookImages[book.id]}" 
                  alt="×¢×˜×™×¤×ª ×”×¡×¤×¨" 
                  onclick="openImageModal('${book.imageUrl || bookImages[book.id]}')"
                  onerror="this.style.display='none'"
                  loading="lazy">` : 
            `<div class="book-img" style="background:#f0f0f0;display:flex;align-items:center;justify-content:center;color:#999;font-size:12px;cursor:default;">××™×Ÿ ×ª××•× ×”</div>`
          }
          <div class="book-info">
            <div class="book-title-author">
                <div class="book-title">${book.title || "×œ×œ× ×›×•×ª×¨×ª"}</div>
                <div class="book-author">×××ª ${book.author || "×œ× ×™×“×•×¢"}</div>
            </div>
            ${book.summary ? `<div class="book-summary">${book.summary}</div>` : ''}
            ${book.location ? `<div class="book-location" style="color:#1976d2;font-size:1em;margin:4px 0;font-weight:500;">ğŸ“ ××™×§×•×: ${book.location}</div>` : ''}
            <div class="book-actions">
                <div id="addImageBox${book.id}" style="margin-bottom:6px;">
                    <button class="add-image-btn" onclick="startAddImage(${book.id})">×”×•×¡×£ ×ª××•× ×”</button>
                </div>
                <div id="summaryBox${book.id}" style="margin-bottom:6px;">
                    <button class="button" onclick="startEditSummary(${book.id})">
                        ${book.summary ? "×¢×¨×•×š ×ª×§×¦×™×¨" : "×”×•×¡×£ ×ª×§×¦×™×¨"}
                    </button>
                </div>
                <div id="locationBox${book.id}" style="margin-bottom:6px;">
                    <button class="button" onclick="startEditLocation(${book.id})">
                        ${book.location ? "×¢×¨×•×š ××™×§×•×" : "×”×•×¡×£ ××™×§×•×"}
                    </button>
                </div>
                <div id="borrowBox${book.id}" style="margin-bottom:6px;">
                    <button class="button" style="padding:5px 16px;" onclick="startBorrow(${book.id})">×”×©××œ</button>
                </div>
                <div id="commentBox${book.id}" style="margin-bottom:6px;">
                    <button class="button" style="padding:5px 16px;" onclick="startComment(${book.id})">×”×•×¡×£ ×ª×’×•×‘×”</button>
                </div>
                <div>
                    <button class="button" style="background:#c62828" onclick="removeBook(${book.id})">××—×§</button>
                </div>
            </div>
            <div style="margin-top:7px;font-size:0.95em;color:#007">
                ${comments[book.id] ? comments[book.id].map((c, index) => `
                    <div style="margin-bottom:5px;">
                        <button class="button button-small" onclick="deleteComment(${book.id}, ${index})" title="××—×§ ×ª×’×•×‘×”">Ã—</button>
                        ğŸ’¬ <b>${c.user}</b>: ${c.text} 
                        <span style="color:#aaa;font-size:0.92em;">(${c.date||''})</span>
                    </div>
                `).join('') : ''}
            </div>
          </div>
      </div>
    `).join('');
}

async function removeBook(id) {
    const code = prompt("×× × ×”×–×Ÿ ××ª ×§×•×“ ×”××™××•×ª ×›×“×™ ×œ××—×•×§ ××ª ×”×¡×¤×¨:");
    if (code !== CODE) {
        showMessage("×§×•×“ ×œ× × ×›×•×Ÿ. ×”×¡×¤×¨ ×œ× × ××—×§.", false);
        return;
    }
    if (confirm("×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×¡×¤×¨?")) {
        const idx = books.findIndex(b => b.id == id);
        if (idx > -1) {
            books.splice(idx, 1);
            delete comments[id];
            delete bookImages[id];
            await saveBooks();
            await fetchBooks();
            showMessage("×”×¡×¤×¨ × ××—×§ ×‘×”×¦×œ×—×”!");
        }
    }
}

function renderBorrowed() {
    const container = document.getElementById('borrowedContainer');
    if (!borrowed.length) { container.innerHTML = "<p style='color:#899;'>××™×Ÿ ×¡×¤×¨×™× ××•×©××œ×™×</p>"; return; }
    container.innerHTML = borrowed.map(book => `
        <div class="book-item" style="background:#f4fff4">
            <div class="book-info-row">
                ${book.imageUrl || bookImages[book.id] ? 
                  `<img class="book-img" src="${book.imageUrl || bookImages[book.id]}" 
                        alt="×¢×˜×™×¤×ª ×”×¡×¤×¨" 
                        onclick="openImageModal('${book.imageUrl || bookImages[book.id]}')"
                        onerror="this.style.display='none'">` : 
                  `<div class="book-img" style="background:#f0f0f0;display:flex;align-items:center;justify-content:center;color:#999;font-size:12px;cursor:default;">××™×Ÿ ×ª××•× ×”</div>`
                }
                <div class="book-title-author">
                    <div class="book-title">${book.title}</div>
                    <div class="book-author">×××ª ${book.author || "×œ× ×™×“×•×¢"}</div>
                </div>
            </div>
            ${book.summary ? `<div class="book-summary">${book.summary}</div>` : ''}
            ${book.location ? `<div class="book-location" style="color:#1976d2;font-size:1em;margin:4px 0;font-weight:500;">ğŸ“ ××™×§×•×: ${book.location}</div>` : ''}
            <div style="margin:3px 0 8px 0;font-size:1.04em;">
                <span>ğŸ“… ×”×•×©××œ ×œ: <b>${book.borrower}</b> ×‘×ª××¨×™×š ${book.date||''}</span>
            </div>
            <button class="button" style="background:#007a31" onclick="returnBook(${book.id})">×”×—×–×¨ ×¡×¤×¨</button>
            <div style="margin-top:7px;font-size:0.97em;color:#007;">
                ${comments[book.id] ? comments[book.id].map((c, index) => `
                    <div style="margin-bottom:5px;">
                        <button class="delete-comment-btn" onclick="deleteComment(${book.id}, ${index})" title="××—×§ ×ª×’×•×‘×”">Ã—</button>
                        ğŸ’¬ <b>${c.user}</b>: ${c.text} 
                        <span style="color:#aaa;font-size:0.92em;">(${c.date||''})</span>
                    </div>
                `).join('') : ''}
            </div>
        </div>
    `).join('');
}

/* --------- SEARCH --------- */
function clearSearch() {
    document.getElementById('searchInput').value = "";
    searchBooks();
}
function setupSearchListeners() {
    document.getElementById('searchInput').addEventListener('input', searchBooks);
    document.getElementById('searchBtn').addEventListener('click', searchBooks);
    document.getElementById('searchInput').addEventListener('keydown', function(e){
        if(e.key==="Enter") searchBooks();
    });
}
function searchBooks() {
    let val = document.getElementById('searchInput').value.trim().toLowerCase();
    let results = document.getElementById('searchResults');
    let listSection = document.getElementById('bookListSection');
    let borrowedSection = document.getElementById('borrowedBooksSection');

    // ××™×œ×™× ××™×•×—×“×•×ª ×œ×—×™×¤×•×© ×¤× ×™××™
    if (val === "×—×¡×¨ ×ª××•× ×”") {
        let noImg = books.filter(b => !(b.imageUrl || bookImages[b.id]));
        if (!noImg.length) {
            results.innerHTML = "<div style='color:#a00'>×›×œ ×”×¡×¤×¨×™× ×›×•×œ×œ×™× ×ª××•× ×”</div>";
        } else {
            results.innerHTML = `<div style="font-weight:bold;color:#b36d0c;">×¡×¤×¨×™× ×œ×œ× ×ª××•× ×”:</div>` +
                noImg.map(book => `
                    <div class="book-item">
                        <div class="book-img" style="background:#f0f0f0;display:flex;align-items:center;justify-content:center;color:#999;font-size:12px;">××™×Ÿ ×ª××•× ×”</div>
                        <div class="book-info">
                            <div class="book-title-author">
                                <div class="book-title">${book.title || "×œ×œ× ×›×•×ª×¨×ª"}</div>
                                <div class="book-author">×××ª ${book.author || "×œ× ×™×“×•×¢"}</div>
                            </div>
                            ${book.summary ? `<div class="book-summary">${book.summary}</div>` : ''}
                            ${book.location ? `<div class="book-location" style="color:#1976d2;">ğŸ“ ××™×§×•×: ${book.location}</div>` : ''}
                        </div>
                    </div>
                `).join('');
        }
        listSection.style.display = "none";
        borrowedSection.style.display = "none";
        return;
    }
    if (val === "×—×¡×¨ ×ª×§×¦×™×¨") {
        let noSummary = books.filter(b => !b.summary || !b.summary.trim());
        if (!noSummary.length) {
            results.innerHTML = "<div style='color:#a00'>×›×œ ×”×¡×¤×¨×™× ×›×•×œ×œ×™× ×ª×§×¦×™×¨</div>";
        } else {
            results.innerHTML = `<div style="font-weight:bold;color:#1976d2;">×¡×¤×¨×™× ×œ×œ× ×ª×§×¦×™×¨:</div>` +
                noSummary.map(book => `
                    <div class="book-item">
                        ${book.imageUrl || bookImages[book.id] ? 
                            `<img class="book-img" src="${book.imageUrl || bookImages[book.id]}" alt="×¢×˜×™×¤×ª ×”×¡×¤×¨">` : 
                            `<div class="book-img" style="background:#f0f0f0;display:flex;align-items:center;justify-content:center;color:#999;font-size:12px;">××™×Ÿ ×ª××•× ×”</div>`
                        }
                        <div class="book-info">
                            <div class="book-title-author">
                                <div class="book-title">${book.title || "×œ×œ× ×›×•×ª×¨×ª"}</div>
                                <div class="book-author">×××ª ${book.author || "×œ× ×™×“×•×¢"}</div>
                            </div>
                            ${book.location ? `<div class="book-location" style="color:#1976d2;">ğŸ“ ××™×§×•×: ${book.location}</div>` : ''}
                        </div>
                    </div>
                `).join('');
        }
        listSection.style.display = "none";
        borrowedSection.style.display = "none";
        return;
    }
    if (val === "×—×¡×¨ ××™×§×•×") {
        let noLocation = books.filter(b => !b.location || !b.location.trim());
        if (!noLocation.length) {
            results.innerHTML = "<div style='color:#a00'>×›×œ ×”×¡×¤×¨×™× ×›×•×œ×œ×™× ××™×§×•×</div>";
        } else {
            results.innerHTML = `<div style="font-weight:bold;color:#43a047;">×¡×¤×¨×™× ×œ×œ× ××™×§×•×:</div>` +
                noLocation.map(book => `
                    <div class="book-item">
                        ${book.imageUrl || bookImages[book.id] ? 
                            `<img class="book-img" src="${book.imageUrl || bookImages[book.id]}" alt="×¢×˜×™×¤×ª ×”×¡×¤×¨">` : 
                            `<div class="book-img" style="background:#f0f0f0;display:flex;align-items:center;justify-content:center;color:#999;font-size:12px;">××™×Ÿ ×ª××•× ×”</div>`
                        }
                        <div class="book-info">
                            <div class="book-title-author">
                                <div class="book-title">${book.title || "×œ×œ× ×›×•×ª×¨×ª"}</div>
                                <div class="book-author">×××ª ${book.author || "×œ× ×™×“×•×¢"}</div>
                            </div>
                            ${book.summary ? `<div class="book-summary">${book.summary}</div>` : ''}
                        </div>
                    </div>
                `).join('');
        }
        listSection.style.display = "none";
        borrowedSection.style.display = "none";
        return;
    }

    // ×—×™×¤×•×© ×¨×’×™×œ
    if (!val) {
        results.innerHTML = "";
        listSection.style.display = "";
        borrowedSection.style.display = "";
        renderBooks();
        renderBorrowed();
        return;
    }
    listSection.style.display = "none";
    borrowedSection.style.display = "none";
    let foundBooks = books.filter(b =>
        (typeof b.title === "string" && b.title.toLowerCase().includes(val)) ||
        (typeof b.author === "string" && b.author.toLowerCase().includes(val)) ||
        (typeof b.summary === "string" && b.summary.toLowerCase().includes(val)) ||
        (typeof b.location === "string" && b.location.toLowerCase().includes(val))
    );
    let foundBorrowed = borrowed.filter(b =>
        (typeof b.title === "string" && b.title.toLowerCase().includes(val)) ||
        (typeof b.author === "string" && b.author.toLowerCase().includes(val)) ||
        (typeof b.summary === "string" && b.summary.toLowerCase().includes(val)) ||
        (typeof b.location === "string" && b.location.toLowerCase().includes(val))
    );
    if (!foundBooks.length && !foundBorrowed.length) {
        results.innerHTML = "<div style='color:#a00'>×œ× × ××¦××• ×¡×¤×¨×™× ××ª××™××™×</div>";
        return;
    }
    let html = "";
    if (foundBooks.length) {
        html += `<div style="font-weight:bold;color:#175;">×¡×¤×¨×™× ×–××™× ×™×:</div>`;
        html += foundBooks.map(book => `
        <div class="book-item">
            ${book.imageUrl || bookImages[book.id] ? 
              `<img class="book-img" src="${book.imageUrl || bookImages[book.id]}" 
                    alt="×¢×˜×™×¤×ª ×”×¡×¤×¨" 
                    onclick="openImageModal('${book.imageUrl || bookImages[book.id]}')"
                    onerror="this.style.display='none'"
                    loading="lazy">` : 
              `<div class="book-img" style="background:#f0f0f0;display:flex;align-items:center;justify-content:center;color:#999;font-size:12px;cursor:default;">××™×Ÿ ×ª××•× ×”</div>`
            }
            <div class="book-info">
              <div class="book-title-author">
                  <div class="book-title">${book.title || "×œ×œ× ×›×•×ª×¨×ª"}</div>
                  <div class="book-author">×××ª ${book.author || "×œ× ×™×“×•×¢"}</div>
              </div>
              ${book.summary ? `<div class="book-summary">${book.summary}</div>` : ''}
              ${book.location ? `<div class="book-location" style="color:#1976d2;font-size:1em;margin:4px 0;font-weight:500;">ğŸ“ ××™×§×•×: ${book.location}</div>` : ''}
              <div class="book-actions">
                  <div id="addImageBox${book.id}" style="margin-bottom:6px;">
                      <button class="add-image-btn" onclick="startAddImage(${book.id})">×”×•×¡×£ ×ª××•× ×”</button>
                  </div>
                  <div id="summaryBox${book.id}" style="margin-bottom:6px;">
                      <button class="button" onclick="startEditSummary(${book.id})">
                          ${book.summary ? "×¢×¨×•×š ×ª×§×¦×™×¨" : "×”×•×¡×£ ×ª×§×¦×™×¨"}
                      </button>
                  </div>
                  <div id="locationBox${book.id}" style="margin-bottom:6px;">
                      <button class="button" onclick="startEditLocation(${book.id})">
                          ${book.location ? "×¢×¨×•×š ××™×§×•×" : "×”×•×¡×£ ××™×§×•×"}
                      </button>
                  </div>
                  <div id="borrowBox${book.id}" style="margin-bottom:6px;">
                      <button class="button" style="padding:5px 16px;" onclick="startBorrow(${book.id})">×”×©××œ</button>
                  </div>
                  <div id="commentBox${book.id}" style="margin-bottom:6px;">
                      <button class="button" style="padding:5px 16px;" onclick="startComment(${book.id})">×”×•×¡×£ ×ª×’×•×‘×”</button>
                  </div>
                  <div>
                      <button class="button" style="background:#c62828" onclick="removeBook(${book.id})">××—×§</button>
                  </div>
              </div>
              <div style="margin-top:7px;font-size:0.95em;color:#007">
                  ${comments[book.id] ? comments[book.id].map((c, index) => `
                      <div style="margin-bottom:5px;">
                          <button class="button button-small" onclick="deleteComment(${book.id}, ${index})" title="××—×§ ×ª×’×•×‘×”">Ã—</button>
                          ğŸ’¬ <b>${c.user}</b>: ${c.text} 
                          <span style="color:#aaa;font-size:0.92em;">(${c.date||''})</span>
                      </div>
                  `).join('') : ''}
              </div>
            </div>
        </div>
        `).join('');
    }
    if (foundBorrowed.length) {
        html += `<div style="font-weight:bold;color:#856300;margin-top:16px;">×¡×¤×¨×™× ××•×©××œ×™×:</div>`;
        html += foundBorrowed.map(book => `
        <div class="book-item" style="background:#f4fff4">
            <div class="book-info-row">
                ${book.imageUrl || bookImages[book.id] ? 
                  `<img class="book-img" src="${book.imageUrl || bookImages[book.id]}" 
                        alt="×¢×˜×™×¤×ª ×”×¡×¤×¨" 
                        onclick="openImageModal('${book.imageUrl || bookImages[book.id]}')"
                        onerror="this.style.display='none'">` : 
                  `<div class="book-img" style="background:#f0f0f0;display:flex;align-items:center;justify-content:center;color:#999;font-size:12px;cursor:default;">××™×Ÿ ×ª××•× ×”</div>`
                }
                <div class="book-title-author">
                    <div class="book-title">${book.title}</div>
                    <div class="book-author">×××ª ${book.author || "×œ× ×™×“×•×¢"}</div>
                </div>
            </div>
            ${book.summary ? `<div class="book-summary">${book.summary}</div>` : ''}
            ${book.location ? `<div class="book-location" style="color:#1976d2;font-size:1em;margin:4px 0;font-weight:500;">ğŸ“ ××™×§×•×: ${book.location}</div>` : ''}
            <div style="margin:3px 0 8px 0;font-size:1.04em;">
                <span>ğŸ“… ×”×•×©××œ ×œ: <b>${book.borrower}</b> ×‘×ª××¨×™×š ${book.date||''}</span>
            </div>
            <button class="button" style="background:#007a31" onclick="returnBook(${book.id});clearSearch()">×”×—×–×¨ ×¡×¤×¨</button>
            <div style="margin-top:7px;font-size:0.97em;color:#007;">
                ${comments[book.id] ? comments[book.id].map((c, index) => `
                    <div style="margin-bottom:5px;">
                        <button class="delete-comment-btn" onclick="deleteComment(${book.id}, ${index})" title="××—×§ ×ª×’×•×‘×”">Ã—</button>
                        ğŸ’¬ <b>${c.user}</b>: ${c.text} 
                        <span style="color:#aaa;font-size:0.92em;">(${c.date||''})</span>
                    </div>
                `).join('') : ''}
            </div>
        </div>
        `).join('');
    }
    results.innerHTML = html;
}


/* --------- ×™×™×¦×•× ××§×¡×œ --------- */
function exportBooks() {
    let code = document.getElementById('exportCode').value;
    if (code !== CODE) { showMessage("×§×•×“ ×œ× × ×›×•×Ÿ", false); return; }
    let allBooks = [
        ...books.map(b=>({...b, borrower:"", borrowedDate:""})),
        ...borrowed.map(b=>({...b, borrower:b.borrower||"", borrowedDate:b.date||""}))
    ];
    let ws = XLSX.utils.json_to_sheet(allBooks);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "×¡×¤×¨×™×");
    XLSX.writeFile(wb, "books.xlsx");
}
/* --------- ×™×‘×•× ××§×¡×œ --------- */
function importBooks() {
    let code = document.getElementById('importCode').value;
    if (code !== CODE) { showMessage("×§×•×“ ×œ× × ×›×•×Ÿ", false); return; }
    let file = document.getElementById('importExcel').files[0];
    if (!file) return showMessage("×œ× × ×‘×—×¨ ×§×•×‘×¥", false);
    let reader = new FileReader();
    reader.onload = function(e) {
        let data = new Uint8Array(e.target.result);
        let workbook = XLSX.read(data, {type:'array'});
        let sheet = workbook.Sheets[workbook.SheetNames[0]];
        let arr = XLSX.utils.sheet_to_json(sheet);
        for(let r of arr) {
            if(!r.title) continue;
            let id = Date.now()+Math.floor(Math.random()*10000);
            books.push({
                id,
                title:r.title,
                author:r.author||'',
                summary:r.summary||'',
                location:r.location||''
            });
        }
        saveBooks().then(fetchBooks);
        showMessage("×¡×¤×¨×™× ×™×•×‘××•!");
    };
    reader.readAsArrayBuffer(file);
}

/* --------- ×ª×§×¦×™×¨ --------- */
function startEditSummary(id) {
    const book = books.find(b => b.id == id);
    const summary = (book && book.summary) || '';
    document.getElementById('summaryBox'+id).innerHTML = `
        <textarea id="summaryInput${id}" style="width:220px;height:60px;display:inline-block;" placeholder="×ª×§×¦×™×¨">${summary}</textarea>
        <button class="button" style="padding:5px 12px;" onclick="saveSummary(${id})">×©××•×¨</button>
        <button class="button" style="padding:5px 12px;background:#999;" onclick="cancelEditSummary(${id})">×‘×™×˜×•×œ</button>
    `;
}
async function saveSummary(id) {
    const summary = document.getElementById('summaryInput'+id).value.trim();
    const book = books.find(b => b.id == id);
    if (book) {
        book.summary = summary;
        await saveBooks();
        await fetchBooks();
        showMessage("×”×ª×§×¦×™×¨ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!");
    }
}
function cancelEditSummary(id) { renderBooks(); }

/* --------- × ×’×™×©×•×ª --------- */
const ACCESS_FONT_KEY = 'library_font_size';
const ACCESS_CONTRAST_KEY = 'library_contrast';
const ACCESS_DARK_KEY = 'library_dark';

function toggleAccessibilityMenu() {
    document.getElementById('accessibilityMenu').classList.toggle('open');
}
function setFontSize(delta) {
    let fs = +localStorage.getItem(ACCESS_FONT_KEY) || 16;
    fs += delta;
    if (fs < 13) fs = 13;
    if (fs > 28) fs = 28;
    document.documentElement.style.fontSize = fs + "px";
    localStorage.setItem(ACCESS_FONT_KEY, fs);
}
function resetFontSize() {
    document.documentElement.style.fontSize = "16px";
    localStorage.setItem(ACCESS_FONT_KEY, 16);
}
function toggleContrast() {
    let enabled = document.body.classList.toggle('accessibility-contrast');
    localStorage.setItem(ACCESS_CONTRAST_KEY, enabled ? "1" : "");
}
function toggleDarkModeAcc() {
    let enabled = document.body.classList.toggle('accessibility-dark');
    localStorage.setItem(ACCESS_DARK_KEY, enabled ? "1" : "");
}
(function(){
    let fs = +localStorage.getItem(ACCESS_FONT_KEY);
    if (fs && fs >= 13 && fs <= 28)
        document.documentElement.style.fontSize = fs + "px";
    if (localStorage.getItem(ACCESS_CONTRAST_KEY))
        document.body.classList.add('accessibility-contrast');
    if (localStorage.getItem(ACCESS_DARK_KEY))
        document.body.classList.add('accessibility-dark');
})();
document.addEventListener('mousedown', function(e){
    const menu = document.getElementById('accessibilityMenu');
    const btn = document.querySelector('.accessibility-btn');
    if (!menu.contains(e.target) && !btn.contains(e.target)) {
        menu.classList.remove('open');
    }
});
window.onload = async function() {
    await fetchBooks();
    setupSearchListeners();
    document.getElementById('searchInput').addEventListener('input', searchBooks);
};
</script>


</body>
</html>
